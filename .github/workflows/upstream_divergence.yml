name: Upstream Divergence Report

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      warning_commits:
        description: 'Warning threshold for commits behind'
        required: false
        default: '50'
      critical_commits:
        description: 'Critical threshold for commits behind'
        required: false
        default: '100'
      show_all:
        description: 'Show all repos including ok status'
        required: false
        default: 'false'

permissions:
  contents: read
  issues: write

jobs:
  divergence-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Generate upstream divergence report
        id: report
        run: |
          WARNING_COMMITS="${{ github.event.inputs.warning_commits || 50 }}"
          CRITICAL_COMMITS="${{ github.event.inputs.critical_commits || 100 }}"
          SHOW_ALL="${{ github.event.inputs.show_all || false }}"

          OUTPUT_FILE=divergence_report.txt
          ARGS="--warning-commits $WARNING_COMMITS --critical-commits $CRITICAL_COMMITS"

          if [ "$SHOW_ALL" = "true" ]; then
            ARGS="$ARGS --all"
          fi

          uv run python scripts/upstream_divergence_report.py $ARGS | tee $OUTPUT_FILE
          
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          
          echo "## Upstream Divergence Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat $OUTPUT_FILE >> $GITHUB_STEP_SUMMARY

      - name: Create issue for critical divergence
        if: steps.report.outputs.exit_code == 2
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'divergence-report'
            });
            
            if (issues.length > 0) {
              console.log('Existing divergence report issue found, skipping creation');
              return;
            }
            
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Critical Upstream Divergence - ${new Date().toISOString().split('T')[0]}`,
              body: `The following repositories have critical upstream divergence:\n\nSee workflow run for details: ${context.payload.repository.html_url}/actions/runs/${context.runId}`,
              labels: ['divergence-report', 'automation']
            });
            
            console.log(`Created issue #${issue.number}`);
